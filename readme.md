makefile2batch
==============

Makefile to Batchfile converter.

```
$ makefile2batch [-f Makefile] {MACRO=VALUE} > make.cmd
```

Supported Macros
----------------

* `$@` ... target filename
* `$*` ... target filename without extension
* `$<` ... first source filename
* `$^` ... all source filenames
* `$(MAKE)` ... the batchfile name
* `$(MAKEDIR)` ... the directory where the batchfile exists

Sample
-------

### Source

```Makefile
TARGET=makefile2batch.exe

$(TARGET): main.go
	go fmt
	go build -o $@ -ldflags "-s -w"

test:
	makefile2batch > make.cmd

readme:
	gawk "/^```make.cmd/{ print $0 ; while( getline < \"make.cmd\" ){ print } ; print \"```\" ; exit } ; 1" readme.md | nkf32 -Lu > readme.new && move readme.new readme.md

clean:
	if exist make.cmd del make.cmd
	if exist makefile2batch.exe del makefile2batch.exe

upgrade:
	for /F "skip=1" %%I in ('where $(TARGET)') do copy /-Y /v "$(TARGET)" "%%I"
```

### make.cmd created by `makefile2batch > make.cmd`

```make.cmd
@rem ***
@rem *** Code generated by `makefile2batch`; DO NOT EDIT.
@rem *** ( https://github.com/zetamatta/makefile2batch )
@rem ***
@setlocal
@set "PROMPT=$$ "
@call :"%1"
@endlocal
@exit /b
:""
  @call :"makefile2batch.exe"
  @exit /b

:"clean"
  @if exist "clean" @exit /b
  @setlocal
  if exist make.cmd del make.cmd
  @if errorlevel 1 echo ERROR %ERRORLEVEL% & exit /b %ERRORLEVEL%
  @endlocal
  @setlocal
  if exist makefile2batch.exe del makefile2batch.exe
  @if errorlevel 1 echo ERROR %ERRORLEVEL% & exit /b %ERRORLEVEL%
  @endlocal
  @exit /b

:"makefile2batch.exe"
  @call :test makefile2batch.exe main.go && @exit /b
  @setlocal
  go fmt
  @if errorlevel 1 echo ERROR %ERRORLEVEL% & exit /b %ERRORLEVEL%
  @endlocal
  @setlocal
  go build -o makefile2batch.exe -ldflags "-s -w"
  @if errorlevel 1 echo ERROR %ERRORLEVEL% & exit /b %ERRORLEVEL%
  @endlocal
  @exit /b

:"readme"
  @if exist "readme" @exit /b
  @setlocal
  gawk "/^```make.cmd/{ print $0 ; while( getline < \"make.cmd\" ){ print } ; print \"```\" ; exit } ; 1" readme.md | nkf32 -Lu > readme.new && move readme.new readme.md
  @if errorlevel 1 echo ERROR %ERRORLEVEL% & exit /b %ERRORLEVEL%
  @endlocal
  @exit /b

:"test"
  @if exist "test" @exit /b
  @setlocal
  makefile2batch > make.cmd
  @if errorlevel 1 echo ERROR %ERRORLEVEL% & exit /b %ERRORLEVEL%
  @endlocal
  @exit /b

:"upgrade"
  @if exist "upgrade" @exit /b
  @setlocal
  for /F "skip=1" %%I in ('where makefile2batch.exe') do copy /-Y /v "makefile2batch.exe" "%%I"
  @if errorlevel 1 echo ERROR %ERRORLEVEL% & exit /b %ERRORLEVEL%
  @endlocal
  @exit /b

:test
  @if not exist "%~1" exit /b 1
  @if "%~2" == "" exit /b 0
  @setlocal
  @for /F "tokens=2,3" %%I in ('where /R . /T "%~1"') do @set TARGET=%%I_%%J
  @echo %TARGET% | findstr _[0-9]: > nul && set TARGET=%TARGET:_=_0%

:each_source
  @for /F "tokens=2,3" %%I in ('where /R . /T "%~2"') do @set SOURCE=%%I_%%J
  @echo %SOURCE% | findstr _[0-9]: > nul && @set SOURCE=%SOURCE:_=_0%
  @if "%SOURCE%" gtr "%TARGET%" @exit /b 1
  @shift
  @if not "%~2" == "" goto :each_source
  @endlocal & exit /b 0
```
